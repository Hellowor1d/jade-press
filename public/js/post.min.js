!function(){var t=Vue.$alert;Vue.use(zPagenav),Vue.use(jadeEditor);var e=new Vue({el:"body",data:{loaded:!0,tab:"list",fileTab:"file-upload",form1:null,form2:null,form3:null,files:[],editor2:"formData2",editor3:"formData3",uploadProgress:0,formData1:{page:1,pageSize:20,maxLink:5,fields:{id:1,desc:1,cats:1,title:1,tags:1,slug:1,files:1,featuredFile:1}},formDataf:{page:1,pageSize:20,maxLink:5,fields:{_id:1,md5:1,filename:1,ext:1}},formData2:{cats:[],files:[],featuredFile:{}},formData3:{},currentEditItem:{},total:0,onSubmit1:!1,onSubmit2:!1,onDel:!1,currentDelItem:{},state:"list",editIndex:0,list:[],showMoreOption2:!1,showMoreOption3:!1,onValidateStyle2:!1,onValidateStyle3:!1,onloadPost:!1,validateStyleMsg2:{},validateStyleMsg3:{},onloadCats:!1,onloadFiles:!1,cats:[],catsOptions:[],rows:10,filesTotal:0},methods:{setTab:function(t){this.tab=t},setFileTab:function(t){"file-list"===t&&this.getFiles(),this.fileTab=t},unsetFeatured:function(t){t.featuredFile={}},isImg:function(t){var e=t.ext;return"jpg"===e||"png"===e||"webp"===e},insertFile:function(t,e){var r=this.isImg(t)?"\nimg(src='"+this.createImgSrc(t)+"', alt='"+t.filename+"')\n":"\na(href='"+this.createImgSrc(t)+"') "+t.filename+"\n";this.$broadcast("je-insert-content",r,e),this.inCats(t,this[e].files)||this[e].files.push(t)},setAsFeatured:function(t,e){e.featuredFile=t},createImgSrc:function(t){return h5.host+"/file/"+t._id+"."+t.ext},createUrl:function(t){return h5.host+h5.routes.post.replace(":catSlug",t.cats.length?t.cats[0].slug:"default").replace(":postSlug",t.slug)},createUrl:function(t,e,r){e=h5.host,r=h5.routes.post;for(var a={":yyyy":function(t,e){return t.replace(":yyyy",e.createTime.getFullYear())},":mm":function(t,e){var r=e.createTime.getMonth();return r=r>9?r+"":"0"+r,t.replace(":mm",r)},":dd":function(t,e){var r=e.createTime.getDate();return r=r>9?r+"":"0"+r,t.replace(":mm",r)},":slug":function(t,e){return t.replace(":slug",e.slug)},":id":function(t,e){return t.replace(":id",e.id)},":_id":function(t,e){return t.replace(":_id",e._id)},":catSlug":function(t,e){return t.replace(":catSlug",e.cats[0].slug)},":catId":function(t,e){return t.replace(":catId",e.cats[0].id)},":cat_id":function(t,e){return t.replace(":cat_id",e.cats[0]._id)}},i=/(:[a-zA-Z_][a-zA-Z_1-9]{0,24})/g,s=r.match(i),n=e+r,o=0,l=s.length;l>o;o++){var u=s[o];n=a[u](n,t)}return n},checkShow:function(t){return"list"===this.state?!0:t._id===this.currentEditItem._id||t._id===this.currentDelItem._id},renderItemCats:function(t){return t.cats.map(function(t){return t.name}).join(",")},inCats:function(t,e){return(e||[]).map(function(t){return t._id}).join(",").indexOf(t._id)>-1},remove:function(t,e){for(var r=0,a=e.length;a>r;r++)if(t._id===e[r]._id)return e.splice(r,1)},toggleCat:function(t,e){this.inCats(t,e)?this.remove(t,e):e.push(t)},toggleShowMore:function(t){var e="showMoreOption"+(t||"");this[e]=!this[e]},formHook2:function(t){this._form2=t},setPristine:function(){var t=this;Vue.nextTick(function(){t._form2.setPristine()})},setDirty:function(){this._form2.setDirty()},edit:function(t,e){this.state="edit",this.editIndex=e,this.loadPost(t)},validateStyle:function(t){var e=this,r=e["onValidateStyle"+t];if(!r){r=!0;var a=e["formData"+t].style;$.ajax({type:"post",url:h5.host+"/api/post/validate-style",data:{style:a}}).then(function(a){r=!1;var i=a;if(i.errorMsg||i.errs){var s=i.errorMsg||i.errs.join(";");e["validateStyleMsg"+t]={hasResult:!0,pass:!1,msg:s}}else e["validateStyleMsg"+t]={hasResult:!0,pass:!0}},function(a){r=!1,e["validateStyleMsg"+t]={hasResult:!0,pass:!1,msg:"validation failed"}})}},loadPost:function(e){var r=this;r.onloadPost||(r.onloadPost=!0,$.ajax({type:"post",url:h5.host+"/api/post/get",data:{_id:e._id,page:1,pageSize:1,fields:{title:1,desc:1,style:1,script:1,slug:1,tags:1,cats:1,content:1,files:1,featuredFile:1}}}).then(function(e){r.onloadPost=!1;var a=e;if(a.errorMsg||a.errs){var i=a.errorMsg||a.errs.join(";");t(i,"danger","#item",1e4)}else r.currentEditItem=Object.assign({},a.result[0]),r.formData3=Object.assign({},r.currentEditItem),r.registerFileUpload()},function(t){r.validateStyleMsg2={hasResult:!0,pass:!1,msg:"validation failed"}}))},getUrl:function(t){var e=h5.access.filter(function(e){return e.indexOf("post")>-1&&e.indexOf(t)>-1});return e.length?1===e.length?e[0]:(e.filter(function(t){return-1===t.indexOf("self")}),e[0]):"/api/post/"+t+"-self"},del:function(t){this.state="del",this.currentDelItem=Object.assign({},t)},cancelEdit:function(t){this.state="list",this.currentEditItem={}},cancel:function(t){this.state="list",this.currentDelItem={}},reset:function(){this.formData2={cats:[],files:[],featuredFile:{}}},add:function(){var e=this;if(!e.onSubmit2){if(e.form2.$invalid)return this.setDirty();e.onSubmit2=!0,$.ajax({type:"post",url:h5.host+"/api/post/add",data:e.formData2}).then(function(r){e.onSubmit2=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msg2"):(e.reset(),e.setPristine(),t("add new category done","success","#msg2",1e4),e.total++,e.list.push(a.result))},function(r){e.onSubmit2=!1,t("add cat failed","danger","#msg1")})}},update:function(){var e=this;if(!e.onSubmit3&&!e.form3.$invalid){e.onSubmit3=!0;var r=e.getUrl("update");$.ajax({type:"post",url:r,data:e.formData3}).then(function(r){e.onSubmit3=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msg31",1e4):(e.list.$set(e.editIndex,e.formData3),e.state="list",e.currentEditItem={})},function(r){e.onSubmit3=!1,t("update cat failed","danger","#msg31",1e4)})}},delConfirm:function(e,r){var a=this;if(!a.onDel){var i={_id:this.currentDelItem._id};a.onDel=!0;var s=a.getUrl("del");$.ajax({type:"post",url:s,data:i}).then(function(e){a.onDel=!1;var i=e;i.errorMsg||i.errs?t(i.errorMsg||i.errs.join(";"),"danger","#msg-item",1e4):(a.list.splice(r,1),a.total--,a.state="list",t("delete done","success","#msg3",1e4))},function(e){a.onDel=!1,t("del failed","danger","#msg-item",1e4)})}},getList:function(){var e=this;e.onSubmit1||e.form1.$invalid||(e.onSubmit1=!0,$.ajax({type:"post",url:h5.host+"/api/post/get",data:e.formData1}).then(function(r){e.onSubmit1=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msg1"):(e.total=a.total,e.list=a.result)},function(r){e.onSubmit1=!1,t("get list failed","danger","#msg1")}))},getCats:function(){var e=this;e.onloadCats||(e.onloadCats=!0,$.ajax({type:"post",url:h5.host+"/api/cat/get",data:{parentId:"__root_cat",pageSize:1e3,page:1,fields:{name:1,desc:1,id:1,parentId:1,slug:1}}}).then(function(r){e.onloadCats=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msg1"):(e.cats=a.result,e.catsOptions=[{_id:"",name:"all category"}].concat(e.cats),e.formData1.catId=e.catsOptions[0]._id)},function(r){e.onloadCats=!1,t("get cat list failed","danger","#msg1")}))},getFiles:function(){var e=this;e.onloadFiles||(e.onloadFiles=!0,$.ajax({type:"post",url:h5.host+"/api/file/get",data:this.formDataf}).then(function(r){e.onloadFiles=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msgf"):(e.files=a.result,e.filesTotal=a.total)},function(r){e.onloadFiles=!1,t("get file list failed","danger","#msgf")}))},md5check:function(){var e=this;$.ajax({type:"post",url:h5.host+"/api/file/get",data:this.formDataf}).then(function(r){e.onloadFiles=!1;var a=r;a.errorMsg||a.errs?t(a.errorMsg||a.errs.join(";"),"danger","#msgf"):(e.files=a.result,e.filesTotal=a.total)},function(r){e.onloadFiles=!1,t("get file list failed","danger","#msgf")})},registerFileUpload:function(){Vue.nextTick(function(){$("#file3").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,a){var i=a.result;return i.errorMsg||i.errs?t(i.errorMsg||i.errs.join(";"),"danger","#file-err3"):(e.files.push(i.result),e.formData3.files.push(i.result),void e.filesTotal++)},error:function(e,r){return t(r+" please retry","danger","#file-err3")},progressall:function(t,r){e.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(t,e){console.log(e),e.submit()}})})}},events:{"page-change":function(t){this.getList()}}});e.getCats(),e.getList(),$(function(){$("#file2").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,a){var i=a.result;return i.errorMsg||i.errs?t(i.errorMsg||i.errs.join(";"),"danger","#file-err2"):(e.files.push(i.result),e.formData2.files.push(i.result),void e.filesTotal++)},error:function(e,r){return t(r+" please retry","danger","#file-err2")},progressall:function(t,r){e.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(t,e){console.log(e),e.submit()}})})}();