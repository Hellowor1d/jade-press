!function(){var e=Vue.$alert;Vue.use(zPagenav),Vue.use(jadeEditor);var t=new Vue({el:"body",data:{loaded:!0,tab:"list",fileTab:"file-upload",form1:null,form2:null,form3:null,files:[],editor2html:"editor2html",editor2htmlOnPreview:!1,editor2htmlOnLoad:!1,editor3html:"editor3html",editor3htmlOnPreview:!1,editor3htmlOnLoad:!1,editor2js:"editor2js",editor3js:"editor3js",editor2style:"editor2style",editor3style:"editor3style",uploadProgress:0,formData1:{page:1,pageSize:20,maxLink:5,published:"",fields:{id:1,desc:1,cats:1,title:1,tags:1,slug:1,files:1,featuredFile:1,published:1}},formDataf:{page:1,pageSize:20,maxLink:5,fields:{_id:1,md5:1,filename:1,ext:1}},formData2:{cats:[],files:[],published:!1,featuredFile:{}},formData3:{},currentEditItem:{},total:0,onSubmit1:!1,onSubmit2:!1,onDel:!1,currentDelItem:{},state:"list",editIndex:0,list:[],showMoreOption2:!1,showMoreOption3:!1,onValidateStyle2:!1,onValidateStyle3:!1,onloadPost:!1,validateStyleMsg2:{},validateStyleMsg3:{},onloadCats:!1,onloadFiles:!1,cats:[],catsOptions:[],rows:10,filesTotal:0},methods:{setTab:function(e){this.tab=e},set:function(e,t){this.$set(e,t)},setFileTab:function(e){"file-list"===e&&this.getFiles(),this.fileTab=e},updateEditor:function(){var e=Array.prototype.slice.call(arguments);this.$broadcast.apply(this,e)},previewContent:function(t){var r=this,i=r[t+"OnPreview"];r[t+"OnPreview"]=!i;var s=r[t+"OnLoad"],a=t.indexOf("2")>-1?r.formData2:r.formData3,n="#"+t+"-preview";s||(s=!0,$.ajax2({type:"post",url:h5.host+"/api/post/preview-html",data:a}).then(function(t){s=!1;var r=t;if(r.errorMsg||r.errs){var i=r.errorMsg||r.errs.join(";");e(i,"danger",n,5e3)}else $(n).html(r.result)},function(t){s=!1,e("parse html failed","danger",n,5e3)}))},unsetFeatured:function(e){e.featuredFile={}},isImg:function(e){var t=(e.ext||"").toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t||"webp"===t},insertFile:function(e,t){var r=this.isImg(e)?"\nimg(src='"+this.createImgSrc(e)+"', alt='"+e.filename+"')\n":"\na(href='"+this.createImgSrc(e)+"') "+e.filename+"\n",i=t.indexOf("2")>-1?"formData2":"formData3";this.$broadcast("je-insert-content",r,t),this.inCats(e,this[i].files)||this[i].files.push(e)},setAsFeatured:function(e,t){t.featuredFile=e},createImgSrc:function(e){return h5.fileServer+"/file/"+e._id+"."+e.ext},createUrl:function(e){var t=h5.host,r=h5.routes.post;return window.h5.createUrl(e,t,r)},checkShow:function(e){return"list"===this.state?!0:e._id===this.currentEditItem._id||e._id===this.currentDelItem._id},renderItemCats:function(e){return e.cats.map(function(e){return e.name}).join(",")},inCats:function(e,t){return(t||[]).map(function(e){return e._id}).join(",").indexOf(e._id)>-1},remove:function(e,t){for(var r=0,i=t.length;i>r;r++)if(e._id===t[r]._id)return t.splice(r,1)},toggleCat:function(e,t){this.inCats(e,t)?this.remove(e,t):t.push(e)},toggleShowMore:function(e){var t="showMoreOption"+(e||"");this[t]=!this[t]},formHook2:function(e){this._form2=e},setPristine:function(){var e=this;Vue.nextTick(function(){e._form2.setPristine()})},setDirty:function(){this._form2.setDirty()},edit:function(e,t){this.state="edit",this.editIndex=t,this.loadPost(e)},validateStyle:function(e){var t=this,r=t["onValidateStyle"+e];if(!r){r=!0;var i=t["formData"+e].style;$.ajax2({type:"post",url:h5.host+"/api/post/validate-style",data:{style:i}}).then(function(i){r=!1;var s=i;if(s.errorMsg||s.errs){var a=s.errorMsg||s.errs.join(";");t["validateStyleMsg"+e]={hasResult:!0,pass:!1,msg:a}}else t["validateStyleMsg"+e]={hasResult:!0,pass:!0}},function(i){r=!1,t["validateStyleMsg"+e]={hasResult:!0,pass:!1,msg:"validation failed"}})}},loadPost:function(t){var r=this;r.onloadPost||(r.onloadPost=!0,$.ajax2({type:"post",url:h5.host+"/api/post/get",data:{_id:t._id,page:1,pageSize:1,fields:{title:1,desc:1,style:1,script:1,slug:1,tags:1,cats:1,content:1,files:1,featuredFile:1,published:1}}}).then(function(t){r.onloadPost=!1;var i=t;if(i.errorMsg||i.errs){var s=i.errorMsg||i.errs.join(";");e(s,"danger","#item",1e4)}else r.currentEditItem=Object.assign({},i.result[0]),r.formData3=Object.assign({},r.currentEditItem),r.registerFileUpload()},function(e){r.validateStyleMsg2={hasResult:!0,pass:!1,msg:"validation failed"}}))},getUrl:function(e){var t=h5.access.filter(function(t){return t.indexOf("post")>-1&&t.indexOf(e)>-1});if(!t.length)return"/api/post/"+e+"-self";if(1===t.length)return t[0];t.filter(function(e){return-1===e.indexOf("self")});return t[0]},del:function(e){this.state="del",this.currentDelItem=Object.assign({},e)},cancelEdit:function(e){this.state="list",this.currentEditItem={}},cancel:function(e){this.state="list",this.currentDelItem={}},reset:function(){this.formData2={cats:[],files:[],featuredFile:{}},this.validateStyleMsg2={}},add:function(){var t=this;if(!t.onSubmit2){if(t.form2.$invalid)return this.setDirty();t.onSubmit2=!0,$.ajax2({type:"post",url:h5.host+"/api/post/add",data:t.formData2}).then(function(r){t.onSubmit2=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg2"):(t.reset(),t.setPristine(),e("add new post done","success","#msg2",1e4),t.total++,t.list.push(i.result))},function(r){t.onSubmit2=!1,e("add post failed","danger","#msg1")})}},update:function(){var t=this;if(!t.onSubmit3&&!t.form3.$invalid){t.onSubmit3=!0;var r=t.getUrl("update");$.ajax2({type:"post",url:r,data:t.formData3}).then(function(r){t.onSubmit3=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg31",1e4):(t.list.$set(t.editIndex,t.formData3),t.state="list",t.currentEditItem={},e("post updated","success","#msg3",3e3))},function(r){t.onSubmit3=!1,e("update post failed","danger","#msg31",1e4)})}},publish:function(t,r){var i=this,s=i.getUrl("update");$.ajax2({type:"post",url:s,data:{_id:t._id,published:!t.published}}).then(function(r){var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg31",1e4):t.published=!t.published},function(t){e("publish post failed","danger","#msg31",1e4)})},delConfirm:function(t,r){var i=this;if(!i.onDel){var s={_id:this.currentDelItem._id};i.onDel=!0;var a=i.getUrl("del");$.ajax2({type:"post",url:a,data:s}).then(function(t){i.onDel=!1;var s=t;s.errorMsg||s.errs?e(s.errorMsg||s.errs.join(";"),"danger","#msg-item",1e4):(i.list.splice(r,1),i.total--,i.state="list",e("delete done","success","#msg3",1e4))},function(t){i.onDel=!1,e("del failed","danger","#msg-item",1e4)})}},getList:function(){var t=this;t.onSubmit1||t.form1.$invalid||(t.onSubmit1=!0,$.ajax2({type:"post",url:h5.host+"/api/post/get",data:t.formData1}).then(function(r){t.onSubmit1=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg1"):(t.total=i.total,t.list=i.result)},function(r){t.onSubmit1=!1,e("get list failed","danger","#msg1")}))},getCats:function(){var t=this;t.onloadCats||(t.onloadCats=!0,$.ajax2({type:"post",url:h5.host+"/api/cat/get",data:{parentId:"__root_cat",pageSize:1e3,page:1,fields:{name:1,desc:1,id:1,parentId:1,slug:1}}}).then(function(r){t.onloadCats=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg1"):(t.cats=i.result,t.catsOptions=[{_id:"",name:"all category"}].concat(t.cats),t.formData1.catId=t.catsOptions[0]._id)},function(r){t.onloadCats=!1,e("get cat list failed","danger","#msg1")}))},getFiles:function(){var t=this;t.onloadFiles||(t.onloadFiles=!0,$.ajax2({type:"post",url:h5.host+"/api/file/get",data:this.formDataf}).then(function(r){t.onloadFiles=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msgf"):(t.files=i.result,t.filesTotal=i.total)},function(r){t.onloadFiles=!1,e("get file list failed","danger","#msgf")}))},md5check:function(){var t=this;$.ajax2({type:"post",url:h5.host+"/api/file/get",data:this.formDataf}).then(function(r){t.onloadFiles=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msgf"):(t.files=i.result,t.filesTotal=i.total)},function(r){t.onloadFiles=!1,e("get file list failed","danger","#msgf")})},registerFileUpload:function(){Vue.nextTick(function(){$("#file3").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,i){var s=i.result;return s.errorMsg||s.errs?e(s.errorMsg||s.errs.join(";"),"danger","#file-err3",2e4):(t.files.push(s.result),t.formData2.files.push(s.result),void t.filesTotal++)},error:function(t,r){return e(r+":please retry","danger","#file-err3")},progressall:function(e,r){t.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(r,i){t.md5Check(i.files,"#file-err3").then(function(e){e&&i.submit()},function(t){return e(t.stack||t,"danger","#file-err3")})}})})},animate:function(e,t,r){this.fileTab="file-list";var i="animated "+r,s=$(e).eq(t);s.addClass(i),setTimeout(function(){s.removeClass(i)},1e3)},findFile:function(t,r,i){for(var s=i.indexOf("2")>-1?".files-control2 .files-list2 .list-group-item":".files-control3 .files-list2 .list-group-item",a=0,n=r.length;n>a;a++){var o=r[a];if(t===o.md5)return this.animate(s,a,"tada"),e(o._id+"."+o.ext+" already uploaded","danger",i,1e4),o}return!1},md5Check:function(e,t){var r=this;return r.getMd5(e[0],t).then(r.checkFile)},checkFile:function(t){var r=t.file,i=t.wrap,s=this,a=i.indexOf("2")>-1?"formData2":"formData3";return new Promise(function(t,n){var o=s.findFile(r.md5,s.files,i);return o?t(!1):void $.ajax2({type:"post",url:h5.host+"/api/file/get",data:{md5:r.md5,page:1,pageSize:1,fields:{_id:1,md5:1,filename:1,ext:1}}}).then(function(n){var o=n;if(o.errorMsg||o.errs)e(o.errorMsg||o.errs.join(";"),"danger",i,5e3),t(!0);else if(o.total){var l=o.result[0];s.files.push(l),s[a].files.push(l),e(r.name+" uploaded","success",i,5e3),t(!1)}else t(!0)},function(r){e("get list failed","danger",i,5e3),t(!0)})})},getMd5:function(e,t){return new Promise(function(r,i){browserMD5File(e,function(s,a){s?i(s):(e.md5=a,r({file:e,wrap:t}))})})}},events:{"page-change":function(e){this.getList()}}});t.getCats(),t.getList(),$(function(){$("#file2").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,i){var s=i.result;return s.errorMsg||s.errs?e(s.errorMsg||s.errs.join(";"),"danger","#file-err2"):(t.files.push(s.result),t.formData2.files.push(s.result),void t.filesTotal++)},error:function(t,r){return e(r+":please retry","danger","#file-err2")},progressall:function(e,r){t.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(r,i){t.md5Check(i.files,"#file-err2").then(function(e){e&&i.submit()},function(t){return e(t.stack||t,"danger","#file-err2")})}})})}();