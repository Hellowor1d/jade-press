!function(){var e=Vue.$alert;Vue.use(zPagenav);var t=new Vue({el:"body",data:{loaded:!0,form1:null,list:[],uploadProgress:0,formData1:{page:1,pageSize:20,maxLink:5,fields:{_id:1,md5:1,filename:1,ext:1}},total:0,onSubmit1:!1,onDel:!1,currentDelItem:{},state:"list"},methods:{isImg:function(e){var t=(e.ext||"").toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t||"webp"===t},createImgSrc:function(e){return h5.fileServer+"/file/"+e._id+"."+e.ext},checkShow:function(e){return"list"===this.state?!0:e._id===this.currentDelItem._id},remove:function(e,t){for(var r=0,i=t.length;i>r;r++)if(e._id===t[r]._id)return t.splice(r,1)},del:function(e){this.state="del",this.currentDelItem=Object.assign({},e)},cancel:function(e){this.state="list",this.currentDelItem={}},delConfirm:function(t,r){var i=this;if(!i.onDel){var n={_id:this.currentDelItem._id};i.onDel=!0;var a=h5.host+"/api/file/del";$.ajax2({type:"post",url:a,data:n}).then(function(t){i.onDel=!1;var n=t;n.errorMsg||n.errs?e(n.errorMsg||n.errs.join(";"),"danger","#msg-item",1e4):(i.list.splice(r,1),i.total--,i.state="list",e("delete done","success","#msg3",1e4))},function(t){i.onDel=!1,e("del failed","danger","#msg-item",1e4)})}},getList:function(){var t=this;t.onSubmit1||t.form1.$invalid||(t.onSubmit1=!0,$.ajax2({type:"post",url:h5.host+"/api/file/get",data:t.formData1}).then(function(r){t.onSubmit1=!1;var i=r;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg3"):(t.total=i.total,t.list=i.result)},function(r){t.onSubmit1=!1,e("get list failed","danger","#msg3")}))},animate:function(e,t){var r="animated "+t,i=$(".list-group .list-group-item").eq(e);i.addClass(r),setTimeout(function(){i.removeClass(r)},1e3)},findFile:function(t,r){for(var i=0,n=r.length;n>i;i++){var a=r[i];if(t===a.md5)return this.animate(i,"tada"),e(a._id+"."+a.ext+" already uploaded","danger","#msg3",1e4),a}return!1},md5Check:function(e){var t=this;return t.getMd5(e[0]).then(t.checkFile)},checkFile:function(t){var r=this;return new Promise(function(i,n){var a=r.findFile(t.md5,r.list);return a?i(!1):void $.ajax2({type:"post",url:h5.host+"/api/file/get",data:{md5:t.md5,page:1,pageSize:1,fields:{_id:1,md5:1,filename:1,ext:1}}}).then(function(n){var a=n;if(a.errorMsg||a.errs)e(a.errorMsg||a.errs.join(";"),"danger","#msg3"),i(!0);else if(a.total){var s=a.result[0];r.list.push(s),e(t.name+" uploaded","danger","#msg3"),i(!1)}else i(!0)},function(t){e("get list failed","danger","#msg3"),i(!0)})})},getMd5:function(e){return new Promise(function(t,r){browserMD5File(e,function(i,n){i?r(i):(e.md5=n,t(e))})})}},events:{"page-change":function(e){this.getList()}}});t.getList(),$(function(){$("#file2").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,i){var n=i.result;return n.errorMsg||n.errs?e(n.errorMsg||n.errs.join(";"),"danger","#file-err2"):(t.list.push(n.result),void t.total++)},error:function(t,r){return e(r+" please retry","danger","#file-err2")},progressall:function(e,r){t.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(r,i){t.md5Check(i.files).then(function(e){e&&i.submit()},function(t){return e(t.stack||t,"danger","#file-err2")})}})})}();