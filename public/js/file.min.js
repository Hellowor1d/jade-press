!function(){var e=Vue.$alert;Vue.use(zPagenav);var t=new Vue({el:"body",data:{loaded:!0,form1:null,list:[],uploadProgress:0,formData1:{page:1,pageSize:20,maxLink:5,fields:{_id:1,md5:1,filename:1,ext:1}},total:0,onSubmit1:!1,onDel:!1,currentDelItem:{},state:"list"},methods:{isImg:function(e){var t=(e.ext||"").toLowerCase();return"jpg"===t||"jpeg"===t||"png"===t||"webp"===t},createImgSrc:function(e){return h5.fileServer+"/file/"+e._id+"."+e.ext},checkShow:function(e){return"list"===this.state?!0:e._id===this.currentDelItem._id},remove:function(e,t){for(var r=0,n=t.length;n>r;r++)if(e._id===t[r]._id)return t.splice(r,1)},del:function(e){this.state="del",this.currentDelItem=Object.assign({},e)},cancel:function(e){this.state="list",this.currentDelItem={}},delConfirm:function(t,r){var n=this;if(!n.onDel){var i={_id:this.currentDelItem._id};n.onDel=!0;var o=h5.host+"/api/file/del";$.ajax({type:"post",url:o,data:i}).then(function(t){n.onDel=!1;var i=t;i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#msg-item",1e4):(n.list.splice(r,1),n.total--,n.state="list",e("delete done","success","#msg3",1e4))},function(t){n.onDel=!1,e("del failed","danger","#msg-item",1e4)})}},getList:function(){var t=this;t.onSubmit1||t.form1.$invalid||(t.onSubmit1=!0,$.ajax({type:"post",url:h5.host+"/api/file/get",data:t.formData1}).then(function(r){t.onSubmit1=!1;var n=r;n.errorMsg||n.errs?e(n.errorMsg||n.errs.join(";"),"danger","#msg3"):(t.total=n.total,t.list=n.result)},function(r){t.onSubmit1=!1,e("get list failed","danger","#msg3")}))},findFile:function(e,t){for(var r=0,n=t.length;n>r;r++){var i=t[r];if(e===i.md5)return i}return!1},md5Check:function(e){var t=this;return t.getMd5(e[0]).then(t.checkFile)},checkFile:function(t){var r=this;return new Promise(function(n,i){var o=r.findFile(t.md5,r.list);return o?n(!1):void $.ajax({type:"post",url:h5.host+"/api/file/get",data:{md5:t.md5,page:1,pageSize:1,fields:{_id:1,md5:1,filename:1,ext:1}}}).then(function(i){var o=i;if(o.errorMsg||o.errs)e(o.errorMsg||o.errs.join(";"),"danger","#msg3"),n(!0);else if(o.total){var s=o.result[0];r.list.push(s),e(t.name+" uploaded","danger","#msg3"),n(!1)}else n(!0)},function(t){e("get list failed","danger","#msg3"),n(!0)})})},getMd5:function(e){return new Promise(function(t,r){browserMD5File(e,function(n,i){n?r(n):(console.log(e.name,i),e.md5=i,t(e))})})}},events:{"page-change":function(e){this.getList()}}});t.getList(),$(function(){$("#file2").fileupload({dataType:"json",formData:{},url:h5.host+"/api/file/add",done:function(r,n){var i=n.result;return i.errorMsg||i.errs?e(i.errorMsg||i.errs.join(";"),"danger","#file-err2"):(t.list.push(i.result),void t.total++)},error:function(t,r){return e(r+" please retry","danger","#file-err2")},progressall:function(e,r){t.uploadProgress=Math.floor(100*r.loaded/r.total)},add:function(r,n){t.md5Check(n.files).then(function(e){e&&n.submit()},function(t){return e(s.stack||t,"danger","#file-err2")})}})})}();