!function(){var t=Vue.$alert;Vue.use(zPagenav),Vue.use(jadeEditor);var e=new Vue({el:"body",data:{loaded:!0,tab:"list",form1:null,form2:null,form3:null,formData1:{page:1,pageSize:20,maxLink:5,fields:{id:1,desc:1,access:1,name:1}},formData2:{access:[]},formData3:{},currentEditItem:{},total:0,onSubmit1:!1,onSubmit2:!1,onDel:!1,currentDelItem:{},state:"list",editIndex:0,list:[],showMoreOption2:!1,showMoreOption3:!1,onValidateStyle2:!1,onValidateStyle3:!1,onloadPost:!1,validateStyleMsg2:{},validateStyleMsg3:{},onloadCats:!1,cats:[],catsOptions:[],rows:10},computed:{},methods:{setTab:function(t){this.tab=t},createUrl:function(t){return h5.host+h5.routes.post.replace(":catSlug",t.cats.length?t.cats[0].slug:"default").replace(":postSlug",t.slug)},checkShow:function(t){return"list"===this.state?!0:t._id===this.currentEditItem._id||t._id===this.currentDelItem._id},renderItemCats:function(t){return t.cats.map(function(t){return t.name}).join(",")},inCats:function(t,e){return(e||[]).map(function(t){return t._id}).join(",").indexOf(t._id)>-1},remove:function(t,e){for(var s=0,a=e.length;a>s;s++)if(t._id===e[s]._id)return e.splice(s,1)},toggleCat:function(t,e){this.inCats(t,e)?this.remove(t,e):e.push(t)},toggleShowMore:function(t){var e="showMoreOption"+(t||"");this[e]=!this[e]},formHook2:function(t){this._form2=t},setPristine:function(){var t=this;Vue.nextTick(function(){t._form2.setPristine()})},setDirty:function(){this._form2.setDirty()},edit:function(t,e){this.state="edit",this.editIndex=e,this.loadPost(t)},validateStyle:function(t){var e=this,s=e["onValidateStyle"+t],a=e["validateStyleMsg"+t];if(!s){s=!0;var r=e["formData"+t].style;$.ajax({type:"post",url:h5.host+"/api/post/validate-style",data:{style:r}}).then(function(t){s=!1;var e=t;if(e.errorMsg||e.errors){var r=e.errorMsg||e.errors.join(";");a={hasResult:!0,pass:!1,msg:r}}else a={hasResult:!0,pass:!0}},function(t){s=!1,a={hasResult:!0,pass:!1,msg:"validation failed"}})}},loadPost:function(e){var s=this;s.onloadPost||(s.onloadPost=!0,$.ajax({type:"post",url:h5.host+"/api/post/get",data:{_id:e._id,page:1,pageSize:1,fields:{title:1,desc:1,style:1,script:1,slug:1,tags:1,cats:1}}}).then(function(e){s.onloadPost=!1;var a=e;if(a.errorMsg||a.errors){var r=a.errorMsg||a.errors.join(";");t(r,"danger","#item",1e4)}else s.currentEditItem=Object.assign({},a.result[0]),s.formData3=Object.assign({},s.currentEditItem)},function(t){s.validateStyleMsg2={hasResult:!0,pass:!1,msg:"validation failed"}}))},getUrl:function(t){var e=h5.access.filter(function(e){return e.indexOf("post")>-1&&e.indexOf(t)>-1});return e.length?1===e.length?e[0]:(e.filter(function(t){return-1===t.indexOf("self")}),e[0]):"/api/post/"+t+"-self"},del:function(t){this.state="del",this.currentDelItem=Object.assign({},t)},cancelEdit:function(t){this.state="list",this.currentEditItem={}},cancel:function(t){this.state="list",this.currentDelItem={}},reset:function(){this.formData2={cats:[]}},add:function(){var e=this;if(!e.onSubmit2){if(e.form2.$invalid)return this.setDirty();e.onSubmit2=!0,$.ajax({type:"post",url:h5.host+"/api/post/add",data:e.formData2}).then(function(s){e.onSubmit2=!1;var a=s;a.errorMsg?t(a.errorMsg,"danger","#msg2"):a.errors?t(a.errors.join(";"),"danger","#msg2"):(e.reset(),e.setPristine(),t("add new category done","success","#msg2",1e4),e.total++,e.list.push(a.result))},function(s){e.onSubmit2=!1,t("add cat failed","danger","#msg1")})}},update:function(){var e=this;if(!e.onSubmit3&&!e.form3.$invalid){e.onSubmit3=!0;var s=e.getUrl("update");$.ajax({type:"post",url:s,data:e.formData3}).then(function(s){e.onSubmit3=!1;var a=s;a.errorMsg?t(a.errorMsg,"danger","#msg31",1e4):a.errors?t(a.errors.join(";"),"danger","#msg31",1e4):(e.list.$set(e.editIndex,e.formData3),e.state="list",e.currentEditItem={})},function(s){e.onSubmit3=!1,t("update cat failed","danger","#msg31",1e4)})}},delConfirm:function(e,s){var a=this;if(!a.onDel){var r={_id:this.currentDelItem._id};a.onDel=!0;var i=a.getUrl("del");$.ajax({type:"post",url:i,data:r}).then(function(e){a.onDel=!1;var r=e;r.errorMsg?t(r.errorMsg,"danger","#msg-item",1e4):r.errors?t(r.errors.join(";"),"danger","#msg-item",1e4):(a.list.splice(s,1),a.total--,a.state="list",t("delete done","success","#msg3",1e4))},function(e){a.onDel=!1,t("del failed","danger","#msg-item",1e4)})}},getList:function(){var e=this;e.onSubmit1||e.form1.$invalid||(e.onSubmit1=!0,$.ajax({type:"post",url:h5.host+"/api/post/get",data:e.formData1}).then(function(s){e.onSubmit1=!1;var a=s;a.errorMsg?t(a.errorMsg,"danger","#msg1"):a.errors?t(a.errors.join(";"),"danger","#msg1"):(e.total=a.total,e.list=a.result)},function(s){e.onSubmit1=!1,t("get list failed","danger","#msg1")}))},getCats:function(){var e=this;e.onloadCats||(e.onloadCats=!0,$.ajax({type:"post",url:h5.host+"/api/cat/get",data:{parentId:"__root_cat",pageSize:1e3,page:1,fields:{name:1,desc:1,id:1,parentId:1,slug:1}}}).then(function(s){e.onloadCats=!1;var a=s;a.errorMsg?t(a.errorMsg,"danger","#msg1"):a.errors?t(a.errors.join(";"),"danger","#msg1"):(e.cats=a.result,e.catsOptions=[{_id:"",name:"all category"}].concat(e.cats),e.formData1.catId=e.catsOptions[0]._id)},function(s){e.onloadCats=!1,t("get cat list failed","danger","#msg1")}))}},events:{"page-change":function(t){this.getList()}}});e.getCats(),e.getList()}();